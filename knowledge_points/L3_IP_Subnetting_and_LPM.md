# 知识点精讲：网络层 (L3) IP 子网切割与最长前缀匹配 (LPM) ✂️

这是整门课程中**最残暴的数字游戏**。几乎在每一年的期末考试（包括 2022、2024 Endterm），教授都会出一张巨大的拓扑图，给你一个初始大 IP 段，要求你手工把它切碎分给几个机房（Subnetting），最后再填一次路由器的转发表（LPM）。

为了让你考场上**不用死算二进制**也能拿满分，我为你独家盘点了这套“魔法块 (Magic Block)”快算心法，以及 2025 年真题的路由表推盘。

---

## 绝对杀招 1：IP 子网切割 (Subnetting) 秒算心法

绝大多数题目都会让你在 `/24` 到 `/30` 之间切蛋糕。只要背熟下面这个**“魔法块大小 (Block Size)”**转换表，连草稿纸都不需要：

### 必背推算表 (针对最后一位主机号)
用公式：**块大小 = $2^{(32 - 掩码)}$**，也就是**总 IP 数量**。
- `/24` = 块大小 256 (一台机器霸占整个段 `0-255`)
- `/25` = 块大小 128 (通常用于把大网切两半：`0-127` 和 `128-255`)
- `/26` = 块大小 64 (切成 4 块：`0-63`, `64-127`, `128-191`, `192-255`)
- `/27` = 块大小 32 (常用)
- `/28` = 块大小 16
- `/29` = 块大小 8
- `/30` = 块大小 4 (超高频！专门分配给只连着两台路由器的“点对点骨干网”！)

### 进阶推算表：隐藏的“第二条魔法公式”（针对 /17 到 /24 的网段）
当遇到像 `/22` 这种跨越到第三个字节（即掩码在 `/17` 到 `/24` 之间）的网段时，我们需要直接算出在**第三个字节**上的跨度。
**公式二（第三字节块大小跨度）= $2^{(24 - 掩码)}$**
- `/24` = 块跨度 1 ($2^0$) 
- `/23` = 块跨度 2 ($2^1$)：相当于管辖 2 个连续的 `/24` 网段（例：`10.0.0.0/23` 管辖 `10.0.0.x` 和 `10.0.1.x`）
- `/22` = 块跨度 4 ($2^2$)：相当于管辖 4 个连续的 `/24` 网段（例：`10.0.0.0/22` 管辖 `10.0.0.x` 到 `10.0.3.x`）
- `/21` = 块跨度 8 ($2^3$)
*(举一反三：如果掩码在 `/9` 到 `/16` 之间，则是在第二字节切蛋糕，块跨度公式就是 $2^{(16 - 掩码)}$。核心法则就是去找离掩码“最近的那个上界 8 的倍数”并相减！)*

### 考场必送分名词：Highest / Lowest Usable Address
> **真题套路**：分配了网段 `172.29.79.192 / 27`，问它的 Network, Broadcast, Lowest usable 和 Highest usable address。

**秒杀四步曲：**
1. 看到 `/27`，立刻反射出**块大小是 32**。
2. 基础底座是 `.192`。那么下一个网段的开头就是 `192 + 32 = 224`。
3. 所以，本网段的统治疆域是从 `.192` 到 `.223` (224 减 1)！
4. **填空答案对号入坐：**
   - **Network Address (网段号，绝对不能给人用)** = `.192` (最底下的地板)
   - **Broadcast Address (广播地址，也绝对不能给人用)** = `.223` (最顶上的天花板)
   - **Lowest Usable (最低可用的主机 IP)** = `.193` (地板加一)
   - **Highest Usable (最高可用主机 IP)** = `.222` (天顶减一)
   - **总可用主机数 (Usable Hosts)** = `32 - 2 = 30` 个！

*(考场上：无论教授怎么出题，只要抓住“地板不准用、天花板是广播”这两个规矩，这 4 分你闭眼全拿！)*

---

## 绝对杀招 2：路由表最长前缀匹配 (LPM) 真题推盘

一旦 IP 切割完毕，所有的 IP 就散布在网络里了。此时，处于十字路口的**路由器 (Router)** 如何决定把收到的包裹踢给谁？
答案是唯一的黄金铁律：**Longest Prefix Match (LPM - 最长前缀匹配)**！

> **真题实战 (2025 Quiz 4)**：
> 路由器的转发表里有以下五个条目：
> | Entry | Destination | Next-Hop |
> |---|---|---|
> | 1 | `10.4.32.0 / 22` | ... |
> | 2 | `10.4.36.0 / 22` | ... |
> | 3 | `10.4.40.0 / 22` | ... |
> | 4 | `10.4.0.0 / 17` | ... |
> | 5 | `0.0.0.0 / 0` (Default) | ... |

**考试连环雷击问答：**

**问题 A**：收到个包，目的地是 `10.15.3.7`，走哪条？
- **扫描**：`10.15` 根本不在 `10.4` 的地盘里。条目 1-4 全部不匹配 (Miss)！
- **LPM 裁决**：如果所有人都不收留它，它只能掉进最后的垃圾桶——兜底路由 (Default Route) `0.0.0.0 / 0`。
- **答案**：走 Entry 5！

**问题 B**：收到个包，目的地是 `10.4.34.7`，走哪条？
- **扫描雷达一**：它符合 `10.4.0.0 /17` 吗？当然符合，`/17` 管得非常宽。
- **扫描雷达二**：它符合 `10.4.32.0 /22` 吗？
  - 这个地方是最大的难点！掩码是 `/22`，根据我们上面刚补齐的**第二条魔法公式**（跨区第三字节），我们要计算它在第 3 个字节上的跨度：`24 - 22 = 2`，块跨度是 $2^2 = 4$。
  - 既然起点落在了 `32`，跨度是 4，下一个网段就是 `36`。所以本网段第三字节的实际管辖范围是从 `10.4.32.x` 到 `10.4.35.x` (即 `36-1`)。
  - 而包裹的第三位数字是 `34`（`34.7`），恰好在 32 到 35 之间！**完全命中！**
- **LPM 终极死斗**：它同时命中了 Entry 4 (`/17`) 和 Entry 1 (`/22`)。根据 LPM 铁律，**谁的斜杠数字越大（前缀越长、管得越精确），谁就赢！** `/22 > /17`。
- **答案**：走 Entry 1！

**问题 C (压轴选择)**：在这个表里，有一条规则是**纯粹多余 (Redundant)** 可以删掉的，是哪条？
- 观察 Entry 2 (`10.4.36.0/22` 指向 `10.4.35.255 eth0`) 和 Entry 4 (`10.4.0.0/17` 也指向 `10.4.35.255 eth0`)。
- 既然 Entry 2 所覆盖的所有人员，统统也属于“老大哥” Entry 4 管的，而且它们最终都会被送到同一个物理出口 (eth0)、同一个 Next-Hop！
- 因此，Entry 2 **完全就是多此一举**！删掉它，包依然可以顺理成章被 Entry 4 接管运过去。
- **答案**：Entry 2 可以被 omit！

---

拿着这两套推断法：一把**魔法块大小刀**，一台 **LPM 扫描仪**，所有关于 IP 规划的连环大坑对你来说都已经是送分单选题了。

接下来，就是把这些散落的珍珠串成项链的时候了。我们需要进入**最宏大的综合大表填表（静态路由 + NAT 改装厂）**的攻略了吗？
